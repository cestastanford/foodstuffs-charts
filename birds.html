<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prussian Foodstuffs, 1640-1688</title>

<link rel="stylesheet" href="bower_components/foundation/css/normalize.css">
<link rel="stylesheet" href="bower_components/foundation/css/foundation.css">
<link rel="stylesheet" href="bower_components/jquery-ui/themes/ui-lightness/jquery-ui.css">
<link rel="stylesheet" href="style.css">

<script src="bower_components/d3/d3.min.js"></script>
<script src="bower_components/topojson/topojson.js"></script>
<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script src="bower_components/jquery-ui/ui/minified/jquery-ui.min.js"></script>
<script src="bower_components/modernizr/modernizr.js"></script>

<!-- <script src="birds.js"></script> -->
<script src="seasonal.js"></script>

</head>

<body>

<section>
  <div class="row">
    <div class="small-12 columns">
      <h2>Foodstuffs, 1640&ndash;1688</h2>
    </div>
  </div>

</section>

  <div class="row">
    <div class="small-87 columns">
    </div>
    <div class="small-4 columns">
      <select name="field-selector" id="field-selector"></select>
    </div>
  </div>

  <div class="small-12 columns" id="mainchart"></div>
  <div class="legend" id="legend"></div>
  <div class="small-12 columns" id="timechart"></div>

<script>
var csvpath = "/data/birds.combined.csv";

var legendWidth = 120;

var margin = {top: 20, right: 20, bottom: 30, left: 60},
    width = 860 - margin.left - margin.right+legendWidth,
    height = 500 - margin.top - margin.bottom,
    time_chart_height = 150 - margin.top - margin.bottom;

var xscale = d3.scale.ordinal()
  .rangeRoundBands([0, width], 0.1);

var yscale = d3.scale.linear()
  .rangeRound([height, 0]);

var colors = d3.scale.ordinal()
    .range(["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5","#393b79","#5254a3","#6b6ecf","#9c9ede","#637939","#8ca252","#b5cf6b","#cedb9c","#8c6d31","#bd9e39","#e7ba52","#e7cb94","#843c39","#ad494a","#d6616b","#e7969c","#7b4173","#a55194","#ce6dbd","#de9ed6"]);

var xaxis = d3.svg.axis()
  .scale(xscale)
  .orient("bottom");

var yaxis = d3.svg.axis()
  .scale(yscale)
  .orient("left")
  .tickFormat(d3.format(".0%"));

var svg = d3.select("#mainchart").append("svg")
  .attr("width", width + margin.left + margin.right + legendWidth)
  .attr("height", height + margin.top + margin.bottom)
  .append("g")
  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var nest = d3.nest()
  .key(function(d) { return d.translation; });

// Tooltip
var tooltip = d3.select("body").append("div")
  .classed("tooltip", true)
  .classed("hidden", true);

// load data
d3.csv(csvpath, function(error, data) {
  // Create array of column headers and map colors to them
  colors.domain(d3.keys(data[0]).filter(function(key) { return key !== "date"; }));

  // Add a `foodTypes` parameter to each row as a percentage
  data.forEach(function(pd) {
    // console.log(pd);
    var y0 = 0;
    // pd.foodTypes will be an array of objects with the column header
    // and range of values
    pd.foodTypes = colors.domain().map(function(foodKeyItem) {
      var foodKeyItemobj = {name: foodKeyItem, y0: y0, yp0: y0};
      y0 += +pd[foodKeyItem];
      foodKeyItemobj.y1 = y0;
      foodKeyItemobj.yp1 = y0;
      return foodKeyItemobj;
    });

    // y0 is the sum of all the values in the row for a food foodCategory
    // Convert the range values to percentages
    pd.foodTypes.forEach(function(d) { d.yp0 /= y0; d.yp1 /= y0; });
    // Save the total
    pd.totalfoodTypes = pd.foodTypes[pd.foodTypes.length - 1];//.y1;
    // console.log(pd.totalfoodTypes);
  });
  // console.log(data);

  xscale.domain(data.map(function(d) { return d.date; }));

  // x axis
  svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xaxis)
    .selectAll("text")
    .attr("y", 5)
    .attr("x", 7)
    .attr("dy", ".35em")
    .attr("transform", "rotate(65)")
    .style("text-anchor", "start");

  // y axis
  svg.append("g")
    .attr("class", "y axis")
    .call(yaxis);

  var foodCategory = svg.selectAll(".foodCategory")
    .data(data)
  .enter().append("g")
    .attr("class", "foodCategory")
    .attr("transform", function(d) { return "translate(" + xscale(d.date) + ",0)"; });

  // Draw rects within groups
  foodCategory.selectAll("rect")
    .data(function(d) { return d.foodTypes; })
  .enter().append("rect")
    .attr("class","food-rect")
    .attr("id", function(d) { return d.name; })
    .attr("width", xscale.rangeBand())
    .attr("y", function(d) { return yscale(d.yp1); })
    .attr("height", function(d) { return yscale(d.yp0) - yscale(d.yp1); })
    .style("fill", function(d) { return colors(d.name); });

  foodCategory.selectAll("rect")
    .on("mousemove", function(d, i) {
      var mouse = d3.mouse(d3.select("body").node());
      tooltip
        .classed("hidden", false)
        .attr("stroke","red")
        .attr("style", "left:" + (mouse[0] + 20) + "px; top:" + (mouse[1] - 50) + "px")
        .html(tooltipText(d));
    })
    .on("mouseout", function(d, i) {
      tooltip.classed("hidden", true);
      tooltip.attr("stroke", "none");
    });

    // Legend
    var svg2 = d3.select("#legend").append("svg")
      .attr("width", 30)
      .attr("height", 20 * data.length);

    var legend = svg2.selectAll(".legend")
      .data(colors.domain().slice())
    .enter().append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

    legend.append("rect")
      .attr("x", width - 18 + legendWidth)
      .attr("width", 18)
      .attr("height", 18)
      .attr("fill", colors)
      .on("mouseover", function(d, i) {
        svg.selectAll("#black grouse").style("stroke", "red").style("stroke-width","2px");
      })
      .on("mouseout", function(d, i) {
        svg.selectAll("#black grouse").style("stroke", "none");
      });

    legend.append("text")
      .attr("x", width - 24 + legendWidth)
      .attr("y", 9)
      .attr("dy", ".35em")
      .style("text-anchor", "end")
      .text(function(d) { return d; });

  // Animation and selection
  d3.selectAll("input").on("change", fieldSelected);

  function fieldSelected() {
    field = fieldSelector.node().value;
    if (this.value === "barchartNormalized") {
      transitionPercent();
    } else if (this.value === "barchartAmount") {
      transitionCount();
    } else if (this.value === "linechartAmount") {
      transitionLine();
    }
  }

  // Transition to 'normalized'
  function transitionPercent() {
    d3.select("svg").style("display", "block");
    d3.select("#timechart").style("display","block");
    d3.selectAll(".foodCategory").style("display", "block");
    d3.selectAll(".foodLine").style("display","none");
    d3.selectAll(".tabulate").style("display","none");

    // reset the yscale domain to default
    yscale.domain([0, 1]);

    // create the transition
    var trans = svg.transition().duration(250);

    // transition the bars
    var categories = trans.selectAll(".foodCategory");
    categories.selectAll("rect")
      .attr("y", function(d) { return yscale(d.yp1); })
      .attr("height", function(d) { return yscale(d.yp0) - yscale(d.yp1); });

    // change the y-axis
    // set the y axis tick format
    yaxis.tickFormat(d3.format(".0%"));
    svg.selectAll(".y.axis").call(yaxis);
  }

  // Transition to 'count'
  function transitionCount() {
    d3.select("svg").style("display", "block");
    d3.select("#timechart").style("display","block");
    d3.selectAll(".foodCategory").style("display","block");
    d3.selectAll(".foodLine").style("display","none");
    d3.selectAll(".tabulate").style("display","none");

    // set the yscale domain
    yscale.domain([0, d3.max(data, function(d) { return d.totalfoodTypes; })]);

    // create the transition
    var transone = svg.transition()
      .duration(250);

    // transition the bars (step one)
    var categoriesone = transone.selectAll(".foodCategory");
    categoriesone.selectAll("rect")
      .attr("y", function(d) { return this.getBBox().y + this.getBBox().height - (yscale(d.y0) - yscale(d.y1)) })
      .attr("height", function(d) { return yscale(d.y0) - yscale(d.y1); });

    // transition the bars (step two)
    var transtwo = transone.transition()
      .delay(500)
      .duration(350)
      .ease("bounce");
    var categoriestwo = transtwo.selectAll(".foodCategory");
    categoriestwo.selectAll("rect")
      .attr("y", function(d) { return yscale(d.y1); });

    // change the y-axis
    // set the y axis tick format
    yaxis.tickFormat(d3.format(".2s"));
    svg.selectAll(".y.axis").call(yaxis);
  }

  function transitionLine() {
    d3.select("svg").style("display", "block");
    d3.select("#timechart").style("display","block");
    d3.selectAll(".tabulate").style("display","none");
    d3.selectAll(".foodCategory").style("display","none");
    d3.selectAll(".foodLine").style("display","block");

    d3.csv(csvpath, function(error, data) {
      colors.domain(d3.keys(data[0]).filter(function(key) { return key !== "date"; }));

      data.forEach(function(d) {
        d.date = d.date;
      });

      var foods = colors.domain().map(function(name) {
        return {
          name: name,
          values: data.map(function(d) {
            return {date: d.date, amount: +d[name]};
          })
        };
      });

      xscale.domain(data.map(function(d) { return d.date; }));

      yscale.domain([
        d3.min(foods, function(c) { return d3.min(c.values, function(v) { return v.amount; }); }),
        d3.max(foods, function(c) { return d3.max(c.values, function(v) { return v.amount; }); })
      ]);

      var line = d3.svg.line()
          .interpolate("linear")
          .x(function(d) { return xscale(d.date); })
          .y(function(d) { return yscale(d.amount); });

      var fooditem = svg.selectAll(".foodLine")
          .data(foods)
        .enter().append("g")
          .attr("class", "foodLine");

      fooditem.append("path")
          .attr("class", "line")
          .attr("d", function(d) { return line(d.values); })
          .style("stroke", function(d) { return colors(d.name); });

      fooditem.append("text")
          .datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; })
          .attr("transform", function(d) { return "translate(" + xscale(d.value.date) + "," + yscale(d.value.amount) + ")"; })
          .attr("x", 3)
          .attr("dy", ".35em");

      // change the y-axis
      // set the y axis tick format
      yaxis.tickFormat(d3.format(".2s"));
      svg.selectAll(".y.axis").call(yaxis);
    });
  }

  var foodMenu = {
    "barchartNormalized": {
      "field": "barchartNormalized",
      "label": "Barchart (Normalized)"
    },
    "barchartAmount": {
      "field": "barchartAmount",
      "label": "Barchart (Count)"
    },
    "linechartAmount": {
      "field": "linechartAmount",
      "label": "Line Chart (Count)"
    }
  };

  // Selector fields
  var fieldSelector = d3.select("#field-selector")
    .on("change", fieldSelected);

  for (var key in foodMenu) {
    fieldSelector.append("option")
    .attr("value", key)
    .text(foodMenu[key].label);
  }

});

function tooltipText(d) {

 return "<h4>" + d.name + "</h4>" +
   "<table>" +
   "<tr>" +
   "<td><strong>Count</strong>: " + (d.y1 - d.y0) + "</td>" +
   "</tr>"+
   "<tr>" +
   // "<td><strong>Proportion</strong>: " + d3.format("%")((+d.y1 - +d.y0) / pd.totalfoodTypes) + "</td>" +
   "</tr?>" +
   "</table>";
}


// title case helper
function toTitleCase(str) {
    return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
}

</script>

</body>
</html>
